; Computer Architectures
; Lab 05 - Exercise 01
#start=8259.exe#
PIC		EQU	40H

CW_8253	EQU	43H

.MODEL small
.STACK
.DATA
isPrime	DB	?
.CODE
.STARTUP
	; CW 00110100 ; Counter 0, Mode 2, Binary
	
	CLI
	MOV DX, CW_8253
	MOV AL, 00110100B	; Counter 0, Mode 2, Binary
	MOV DX, 41H
	MOV AX, 10000		; 10 seconds
	OUT DX, AL 			; LSB
	MOV AL, AH
	OUT DX, AL			; MSB
	CALL INIT_8259
	CALL INIT_IVT
	STI
	XOR AX, AX
CYCLE:
	INC AX
.EXIT

INIT_8259	PROC
	PUSH AX
	PUSH DX
	; ICW 1
	MOV DX, PIC
	MOV AL, 00010011B
	OUT DX, AL
	; ICW 2
	MOV DX, PIC+1
	MOV AL, 00100000B	;	ISR Address
	OUT DX, AL
	; ICW 4
	MOV AL, 00000011B
	OUT DX, AL
	; OCW 1
	MOV AL, 11110111B	;	CH7 Enabled (Port A)
	OUT DX, AL
	POP DX
	POP AX
	RET	
INIT_8259	ENDP

INIT_IVT	PROC
	PUSH AX
	PUSH BX
	PUSH DX
	PUSH DS
	
	XOR AX, AX
	MOV DS, AX
	MOV BX, 00100111B
	SHL BX, 1
	SHL BX, 1
	MOV AX, OFFSET ISR_8253
	MOV DS:[BX], AX
	MOV AX, SEG ISR_8253
	MOV DS:[BX+2], AX
	
	POP DS
	POP DX
	POP BX
	POP AX
	RET
INIT_IVT	ENDP

ISR_8253	PROC
	IRET
ISR_8253	ENDP